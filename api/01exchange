export const config = {
  runtime: 'edge',
};

export default async function handler(request) {
  try {
    // 01 Exchange API - essayer plusieurs endpoints possibles
    const baseUrl = 'https://zo-mainnet.n1.xyz';
    
    let totalVolume24h = 0;
    let marketsCount = 0;
    let apiWorked = false;

    // Essayer l'endpoint /info ou /markets
    const endpoints = [
      `${baseUrl}/info`,
      `${baseUrl}/v1/info`,
      `${baseUrl}/api/info`,
      `${baseUrl}/markets`,
      `${baseUrl}/v1/markets`,
    ];

    let infoData = null;
    
    for (const endpoint of endpoints) {
      try {
        const response = await fetch(endpoint, {
          headers: {
            'Accept': 'application/json',
          },
        });
        
        if (response.ok) {
          infoData = await response.json();
          apiWorked = true;
          break;
        }
      } catch (e) {
        // Continuer avec le prochain endpoint
      }
    }

    if (!apiWorked || !infoData) {
      throw new Error('Could not connect to 01 Exchange API');
    }

    // Parser les données selon la structure retournée
    if (infoData.markets && Array.isArray(infoData.markets)) {
      for (const market of infoData.markets) {
        const volume = parseFloat(market.volumeQuote24h || market.volume24h || 0);
        totalVolume24h += volume;
        marketsCount++;
      }
    } else if (Array.isArray(infoData)) {
      for (const market of infoData) {
        const volume = parseFloat(market.volumeQuote24h || market.volume24h || 0);
        totalVolume24h += volume;
        marketsCount++;
      }
    }

    // Calculer les fees : volume × 0.02% (moyenne entre 0.01% maker et 0.03% taker)
    const feeRate = 0.0002; // 0.02%
    const fees24h = totalVolume24h * feeRate;

    // Retourner les données formatées comme les autres APIs
    const result = {
      protocol: '01exchange',
      name: '01 Exchange',
      total24h: fees24h,
      total7d: fees24h * 7, // Estimation basée sur 24h
      volume24h: totalVolume24h,
      feeRate: feeRate,
      feeRatePercent: '0.02%',
      marketsCount: marketsCount,
      logo: 'https://01.xyz/favicon.ico',
    };

    return new Response(JSON.stringify(result), {
      status: 200,
      headers: {
        'Content-Type': 'application/json',
        'Cache-Control': 's-maxage=3600, stale-while-revalidate=86400',
      },
    });
  } catch (error) {
    return new Response(
      JSON.stringify({ 
        error: error.message,
        protocol: '01exchange' 
      }),
      {
        status: 500,
        headers: { 'Content-Type': 'application/json' },
      }
    );
  }
}
